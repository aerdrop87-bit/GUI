{% extends "layouts.html" %}
{% block title %}Visualisasi Data{% endblock %}
{% block page_title %}Visualisasi Data{% endblock %}

{% block content %}
{% set card_cls = "rounded-2xl border border-slate-200 bg-white shadow-sm p-6" %}
{% set input_cls = "w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-sm text-slate-700 outline-none transition focus:border-cyan-500 focus:ring-2 focus:ring-cyan-100" %}

<div class="space-y-6">

    <section class="{{ card_cls }} bg-gradient-to-br from-slate-50 via-white to-cyan-50">
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-2 lg:items-end">
            <div>
                <h2 class="text-xl font-semibold text-slate-900">Dashboard Visualisasi Data Pelanggan</h2>
                <p class="mt-1 text-sm text-slate-600">Setiap chart dilengkapi keterangan konkret agar pembacaan data lebih cepat, jelas, dan bisa langsung dipakai untuk keputusan operasional.</p>
            </div>
            <div>
                <label class="mb-1.5 block text-sm font-medium text-slate-600">Dataset</label>
                <select name="dataset_id" class="{{ input_cls }}"
                        onchange="window.location='{{ url_for('visualisasi') }}?dataset_id=' + this.value;">
                    <option value="">-- Pilih Dataset --</option>
                    {% for d in datasets %}
                    <option value="{{ d.id }}" {% if selected_dataset_id == d.id %}selected{% endif %}>{{ d.filename }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if visual_notes %}
        <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800">
            {% for n in visual_notes %}
            <div>{{ n }}</div>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    {% if selected_dataset %}
    <section class="grid grid-cols-1 gap-6 xl:grid-cols-2">
        <article class="{{ card_cls }}">
            <h3 class="text-lg font-semibold text-slate-900">1) Water Usage Distribution</h3>
            <p class="mt-1 text-sm text-slate-600">Customer count by consumption range.</p>
            {% if usage_distribution %}
            <div id="usage-distribution-chart" class="mt-4 h-[320px]"></div>
            {% else %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Data pemakaian belum tersedia untuk ditampilkan.</div>
            {% endif %}
        </article>

        <aside class="{{ card_cls }}">
            <h4 class="text-base font-semibold text-slate-900">Keterangan Chart 1</h4>
            <p class="mt-2 text-sm text-slate-600">Chart ini menunjukkan jumlah pelanggan pada setiap rentang pemakaian air. Semakin tinggi batang pada rentang tertentu, semakin dominan pola konsumsi di rentang tersebut.</p>
            {% if usage_summary %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 space-y-1">
                <div><span class="font-semibold">Total pelanggan dianalisis:</span> {{ usage_summary.total_customers }}</div>
                <div><span class="font-semibold">Rata-rata pemakaian:</span> {{ "%.2f"|format(usage_summary.avg_usage) }}</div>
                <div><span class="font-semibold">Rentang terbanyak:</span> {{ usage_summary.top_range }} ({{ usage_summary.top_count }} pelanggan)</div>
            </div>
            {% endif %}
            <p class="mt-3 text-xs text-slate-500">Gunakan chart ini untuk menetapkan strategi tarif atau intervensi efisiensi pada kelompok konsumsi dominan.</p>
        </aside>
    </section>

    <section class="grid grid-cols-1 gap-6 xl:grid-cols-2">
        <article class="{{ card_cls }}">
            <h3 class="text-lg font-semibold text-slate-900">2) Customer Distribution by Region</h3>
            <p class="mt-1 text-sm text-slate-600">Geographic segmentation.</p>
            {% if region_distribution %}
            <div id="region-distribution-chart" class="mt-4 h-[320px]"></div>
            {% else %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Data wilayah belum tersedia untuk ditampilkan.</div>
            {% endif %}
        </article>

        <aside class="{{ card_cls }}">
            <h4 class="text-base font-semibold text-slate-900">Keterangan Chart 2</h4>
            <p class="mt-2 text-sm text-slate-600">Chart memperlihatkan sebaran pelanggan per wilayah. Wilayah dengan pelanggan lebih banyak biasanya memiliki dampak operasional dan potensi pendapatan lebih besar.</p>
            {% if region_summary %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 space-y-1">
                <div><span class="font-semibold">Jumlah wilayah:</span> {{ region_summary.total_regions }}</div>
                <div><span class="font-semibold">Wilayah dominan:</span> {{ region_summary.top_region }}</div>
                <div><span class="font-semibold">Kontribusi wilayah dominan:</span> {{ region_summary.top_region_count }} pelanggan ({{ "%.2f"|format(region_summary.top_region_pct) }}%)</div>
            </div>
            {% endif %}
            <p class="mt-3 text-xs text-slate-500">Gunakan chart ini untuk prioritas layanan lapangan, inspeksi jaringan, dan segmentasi program pelanggan.</p>
        </aside>
    </section>

    <section class="grid grid-cols-1 gap-6 xl:grid-cols-2">
        <article class="{{ card_cls }}">
            <h3 class="text-lg font-semibold text-slate-900">3) Cluster Comparison</h3>
            <p class="mt-1 text-sm text-slate-600">Average metrics per cluster.</p>
            {% if cluster_comparison %}
            <div id="cluster-comparison-chart" class="mt-4 h-[340px]"></div>
            {% else %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Perbandingan cluster akan tampil setelah output KMeans tersedia dan dapat digabungkan dengan data mentah.</div>
            {% endif %}
        </article>

        <aside class="{{ card_cls }}">
            <h4 class="text-base font-semibold text-slate-900">Keterangan Chart 3</h4>
            <p class="mt-2 text-sm text-slate-600">Setiap cluster menampilkan rata-rata metrik utama pelanggan. Perbedaan tinggi batang antar cluster menunjukkan karakteristik segmen yang berbeda.</p>
            {% if cluster_summary %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 space-y-1">
                <div><span class="font-semibold">Jumlah cluster aktif:</span> {{ cluster_summary.cluster_count }}</div>
                {% if cluster_summary.top_cluster %}
                <div><span class="font-semibold">Cluster dengan rata-rata pemakaian tertinggi:</span> {{ cluster_summary.top_cluster }}</div>
                <div><span class="font-semibold">Nilai rata-rata pemakaian cluster tertinggi:</span> {{ "%.2f"|format(cluster_summary.top_cluster_usage) }}</div>
                {% endif %}
            </div>
            {% endif %}
            <p class="mt-3 text-xs text-slate-500">Gunakan chart ini untuk membedakan strategi penanganan per cluster (retensi, tarif, edukasi, atau program efisiensi).</p>
        </aside>
    </section>

    <section class="grid grid-cols-1 gap-6 xl:grid-cols-2">
        <article class="{{ card_cls }}">
            <h3 class="text-lg font-semibold text-slate-900">5) Multi-Dimensional Cluster Analysis</h3>
            <p class="mt-1 text-sm text-slate-600">Usage vs Bill Amount by cluster.</p>
            {% if scatter_cluster %}
            <div id="cluster-scatter-chart" class="mt-4 h-[380px]"></div>
            {% else %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Scatter cluster memerlukan data pemakaian, data tagihan, dan hasil cluster yang valid.</div>
            {% endif %}
        </article>

        <aside class="{{ card_cls }}">
            <h4 class="text-base font-semibold text-slate-900">Keterangan Chart 5</h4>
            <p class="mt-2 text-sm text-slate-600">Titik pada chart merepresentasikan pelanggan. Posisi horizontal menunjukkan pemakaian, posisi vertikal menunjukkan tagihan, dan warna titik menunjukkan cluster.</p>
            {% if scatter_summary %}
            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 space-y-1">
                <div><span class="font-semibold">Jumlah titik analisis:</span> {{ scatter_summary.points_count }}</div>
                <div><span class="font-semibold">Korelasi usage-revenue:</span>
                    {% if scatter_summary.corr_usage_revenue is not none %}
                        {{ "%.3f"|format(scatter_summary.corr_usage_revenue) }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
            {% endif %}
            <p class="mt-3 text-xs text-slate-500">Jika korelasi positif tinggi, kenaikan pemakaian cenderung diikuti kenaikan tagihan. Outlier bisa menjadi kandidat audit khusus.</p>
        </aside>
    </section>

    <section class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div class="rounded-2xl border border-cyan-200 bg-cyan-50 p-5">
            <p class="text-sm text-cyan-700">Total Water Consumption</p>
            <p class="mt-1 text-2xl font-semibold text-cyan-900">
                {% if kpi.total_water_consumption is not none %}
                    {{ "{:,.0f}".format(kpi.total_water_consumption) }}
                {% else %}
                    -
                {% endif %}
            </p>
            <p class="mt-2 text-xs text-cyan-800">Akumulasi total pemakaian dari dataset terpilih.</p>
        </div>

        <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-5">
            <p class="text-sm text-emerald-700">Total Revenue</p>
            <p class="mt-1 text-2xl font-semibold text-emerald-900">
                {% if kpi.total_revenue is not none %}
                    Rp {{ "{:,.0f}".format(kpi.total_revenue) }}
                {% else %}
                    -
                {% endif %}
            </p>
            <p class="mt-2 text-xs text-emerald-800">Akumulasi nilai tagihan dari dataset terpilih.</p>
        </div>

        <div class="rounded-2xl border border-violet-200 bg-violet-50 p-5">
            <p class="text-sm text-violet-700">Payment Collection Rate</p>
            <p class="mt-1 text-2xl font-semibold text-violet-900">
                {% if kpi.payment_collection_rate is not none %}
                    {{ "%.2f"|format(kpi.payment_collection_rate) }}%
                {% else %}
                    -
                {% endif %}
            </p>
            <p class="mt-2 text-xs text-violet-800">Persentase pelanggan tertagih dari total pelanggan yang memiliki tagihan.</p>
        </div>
    </section>

    {% else %}
    <section class="{{ card_cls }}">
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Pilih dataset terlebih dahulu untuk menampilkan visualisasi.</div>
    </section>
    {% endif %}

</div>

{% if selected_dataset %}
<script>
const usageDistribution = {{ usage_distribution|tojson }};
const regionDistribution = {{ region_distribution|tojson }};
const clusterComparison = {{ cluster_comparison|tojson }};
const monthlyTrend = {{ monthly_trend|tojson }};
const scatterCluster = {{ scatter_cluster|tojson }};

if (usageDistribution && usageDistribution.length) {
  Plotly.newPlot("usage-distribution-chart", [{
    type: "bar",
    x: usageDistribution.map(d => d.range),
    y: usageDistribution.map(d => d.count),
    marker: {color: "#0ea5e9"}
  }], {
    margin: {t: 10, r: 10, b: 40, l: 45},
    xaxis: {title: "Consumption Range"},
    yaxis: {title: "Customer Count"}
  }, {displayModeBar: false, responsive: true});
}

if (regionDistribution && regionDistribution.length) {
  Plotly.newPlot("region-distribution-chart", [{
    type: "bar",
    x: regionDistribution.map(d => d.region),
    y: regionDistribution.map(d => d.count),
    marker: {color: "#14b8a6"}
  }], {
    margin: {t: 10, r: 10, b: 40, l: 45},
    xaxis: {title: "Region"},
    yaxis: {title: "Customer Count"}
  }, {displayModeBar: false, responsive: true});
}

if (clusterComparison && clusterComparison.length) {
  const keys = Object.keys(clusterComparison[0]).filter(k => k !== "cluster");
  const traces = keys.map(k => ({
    type: "bar",
    name: k,
    x: clusterComparison.map(d => d.cluster),
    y: clusterComparison.map(d => d[k]),
  }));
  Plotly.newPlot("cluster-comparison-chart", traces, {
    barmode: "group",
    margin: {t: 10, r: 10, b: 40, l: 45},
    xaxis: {title: "Cluster"},
    yaxis: {title: "Average Value"}
  }, {displayModeBar: false, responsive: true});
}

if (monthlyTrend && monthlyTrend.length) {
  Plotly.newPlot("monthly-trend-chart", [
    {
      type: "scatter",
      mode: "lines+markers",
      name: "Usage",
      x: monthlyTrend.map(d => d.month),
      y: monthlyTrend.map(d => d.usage),
      line: {color: "#0ea5e9"}
    },
    {
      type: "scatter",
      mode: "lines+markers",
      name: "Revenue",
      x: monthlyTrend.map(d => d.month),
      y: monthlyTrend.map(d => d.revenue),
      yaxis: "y2",
      line: {color: "#22c55e"}
    }
  ], {
    margin: {t: 10, r: 45, b: 40, l: 45},
    xaxis: {title: "Month"},
    yaxis: {title: "Usage"},
    yaxis2: {title: "Revenue", overlaying: "y", side: "right"},
    legend: {orientation: "h", y: 1.15}
  }, {displayModeBar: false, responsive: true});
}

if (scatterCluster && scatterCluster.length) {
  const clusters = [...new Set(scatterCluster.map(d => d.cluster))].sort();
  const traces = clusters.map(c => {
    const rows = scatterCluster.filter(d => d.cluster === c);
    return {
      type: "scatter",
      mode: "markers",
      name: c,
      x: rows.map(d => d.usage),
      y: rows.map(d => d.revenue),
      marker: {size: 8}
    };
  });
  Plotly.newPlot("cluster-scatter-chart", traces, {
    margin: {t: 10, r: 10, b: 45, l: 55},
    xaxis: {title: "Usage"},
    yaxis: {title: "Bill Amount"}
  }, {displayModeBar: false, responsive: true});
}
</script>
{% endif %}
{% endblock %}
